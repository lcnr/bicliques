use crate::*;

use std::cmp::Ordering;
use std::collections::HashSet;

fn all_solutions(g: &Bigraph, k: usize) -> HashSet<BicliqueCover> {
    let mut cliques = HashSet::new();
    enum Never {}
    biclique_covers::<Never, _>(&g, k, |c| {
        if g.is_maximal_cover(&c) {
            assert!(cliques.insert(c));
        }
        ControlFlow::Continue(())
    });
    cliques
}

fn check_solutions<const N: usize>(
    mut v: [&'static str; N],
    g: &Bigraph,
    solutions: &HashSet<BicliqueCover>,
) {
    let mut w = solutions.iter().map(|c| c.print(g)).collect::<Vec<_>>();
    v.sort();
    w.sort();

    let mut err = false;
    macro_rules! err {
        ($($t:tt)*) => {
            {
                err = true;
                eprintln!($($t)*);
            }
        }
    }

    match v.len().cmp(&w.len()) {
        Ordering::Equal => {}
        Ordering::Less => err!("at least {} unexpected elements", w.len() - v.len()),
        Ordering::Greater => err!("at least {} missing elements", v.len() - w.len()),
    }

    let mut v = v.iter().peekable();
    let mut w = w.iter().peekable();
    loop {
        match (v.peek(), w.peek()) {
            (Some(a), None) => err!("missing clique:    {}", a),
            (None, Some(b)) => err!("unexpected clique: {}", b),
            (Some(&&a), Some(b)) => match a.cmp(b.as_str()) {
                Ordering::Equal => {}
                Ordering::Less => {
                    err!("missing clique:    {}", a);
                    v.next();
                    continue;
                }
                Ordering::Greater => {
                    err!("unexpected clique: {}", b);
                    w.next();
                    continue;
                }
            },
            (None, None) => {
                if err {
                    panic!();
                } else {
                    return;
                }
            }
        }

        v.next();
        w.next();
    }
}

const T: bool = true;
const F: bool = false;

#[test]
fn small() {
    let g = Bigraph::from([[T, T], [F, T], [T, F]]);
    let solutions = all_solutions(&g, 5);
    check_solutions(["101|10 110|01", "101|10 110|01 100|11"], &g, &solutions)
}

#[test]
fn syn_le_min() {
    let g = Bigraph::from([
        [T, T, T, T, F],
        [T, T, F, T, T],
        [T, F, T, T, F],
        [T, T, T, T, T],
        [F, T, F, T, T],
    ]);
    let solutions = all_solutions(&g, 4);
    check_solutions(
        [
            "01011|01011 10110|10110 11010|11010",
            "01011|01011 10110|10110 11010|11010 10010|11110",
            "01011|01011 11110|10010 10110|10110 10010|11110",
            "01011|01011 10110|10110 01010|11011 10010|11110",
            "01011|01011 11110|10010 10110|10110 11010|11010",
            "11011|01010 01011|01011 10110|10110 11010|11010",
            "11111|00010 01011|01011 10110|10110 11010|11010",
            "01011|01011 10110|10110 11010|11010 01010|11011",
            "01011|01011 10110|10110 11010|11010 00010|11111",
            "11011|01010 01011|01011 11110|10010 10110|10110",
            "11011|01010 01011|01011 10110|10110 01010|11011",
        ],
        &g,
        &solutions,
    )
}

#[test]
fn containment_err() {
    let g = Bigraph::from([
        [T, T, T, T, T, F],
        [T, T, T, T, F, T],
        [T, F, T, F, F, F],
        [T, T, F, T, F, T],
        [T, F, T, T, T, T],
        [F, T, T, T, T, T],
    ]);
    let solutions = all_solutions(&g, 5);
    check_solutions(
        [
            "000011|001111 100001|011110 111010|101000 010100|110101",
            "010111|000101 100001|011110 111010|101000 100010|101110 110100|110100",
            "010111|000101 100011|001110 100001|011110 111010|101000 110100|110100",
            "000011|001111 010101|010101 111010|101000 110100|110100 100000|111110",
            "000011|001111 110001|011100 111010|101000 010100|110101 100000|111110",
            "000011|001111 110101|010100 111010|101000 010100|110101 100000|111110",
            "000011|001111 100001|011110 111010|101000 010100|110101 110000|111100",
            "000011|001111 100001|011110 111010|101000 110100|110100 010100|110101",
            "010101|010101 100001|011110 111010|101000 000010|101111 110100|110100",
            "000011|001111 010101|010101 100001|011110 111010|101000 110100|110100",
            "000011|001111 110001|011100 100001|011110 111010|101000 010100|110101",
            "000011|001111 110101|010100 100001|011110 111010|101000 010100|110101",
            "000011|001111 110101|010100 010110|100101 111010|101000 100000|111110",
            "000011|001111 100001|011110 010110|100101 111010|101000 110100|110100",
            "010111|000101 100001|011110 111010|101000 000010|101111 110100|110100",
            "010111|000101 000011|001111 100001|011110 111010|101000 110100|110100",
            "000011|001111 110101|010100 100001|011110 010110|100101 111010|101000",
            "010111|000101 100011|001110 110001|011100 111010|101000 110100|110100",
            "010111|000101 100011|001110 110101|010100 111010|101000 110100|110100",
            "010111|000101 100011|001110 110101|010100 110110|100100 111010|101000",
            "100011|001110 010101|010101 010110|100101 111010|101000 110000|111100",
            "100011|001110 010101|010101 110001|011100 010110|100101 111010|101000",
            "010011|001101 100011|001110 110001|011100 111010|101000 010100|110101",
            "010111|000101 100011|001110 110001|011100 111010|101000 010100|110101",
            "000011|001111 110001|011100 111010|101000 100010|101110 010100|110101",
            "100011|001110 000011|001111 110001|011100 111010|101000 010100|110101",
            "100011|001110 010001|011101 010110|100101 111010|101000 110100|110100",
            "010111|000101 100011|001110 010001|011101 111010|101000 110100|110100",
            "100011|001110 110101|010100 010001|011101 010110|100101 111010|101000",
            "100011|001110 010101|010101 111010|101000 010010|101101 110100|110100",
            "100011|001110 010101|010101 010110|100101 111010|101000 110100|110100",
            "010011|001101 100011|001110 010101|010101 111010|101000 110100|110100",
            "010111|000101 100011|001110 010101|010101 111010|101000 110100|110100",
            "100011|001110 110101|010100 010101|010101 010110|100101 111010|101000",
            "010011|001101 100011|001110 110101|010100 111010|101000 010100|110101",
            "010111|000101 100011|001110 110101|010100 111010|101000 010100|110101",
            "000011|001111 010101|010101 111010|101000 100010|101110 110100|110100",
            "000011|001111 110101|010100 111010|101000 100010|101110 010100|110101",
            "100011|001110 010101|010101 111010|101000 000010|101111 110100|110100",
            "100011|001110 000011|001111 010101|010101 111010|101000 110100|110100",
            "100011|001110 000011|001111 110101|010100 111010|101000 010100|110101",
            "010011|001101 100011|001110 110101|010100 010110|100101 111010|101000",
            "010111|000101 100011|001110 110101|010100 010110|100101 111010|101000",
            "010111|000101 100011|001110 110101|010100 111110|100000 111010|101000",
            "000011|001111 110101|010100 010110|100101 111010|101000 100010|101110",
            "100011|001110 000011|001111 110101|010100 010110|100101 111010|101000",
            "110101|010100 000001|011111 010110|100101 111010|101000 100010|101110",
            "100011|001110 110101|010100 000001|011111 010110|100101 111010|101000",
            "000001|011111 010110|100101 111010|101000 100010|101110 110100|110100",
            "010111|000101 000001|011111 111010|101000 100010|101110 110100|110100",
            "100011|001110 000001|011111 010110|100101 111010|101000 110100|110100",
            "010111|000101 100011|001110 000001|011111 111010|101000 110100|110100",
            "010111|000101 111011|001000 100011|001110 110101|010100 111110|100000",
            "000011|001111 010101|010101 110110|100100 111010|101000 100000|111110",
            "000011|001111 010101|010101 111110|100000 111010|101000 100000|111110",
            "000011|001111 100001|011110 111010|101000 010100|110101 100000|111110",
            "100011|001110 010101|010101 010110|100101 111010|101000 100000|111110",
            "000011|001111 010001|011101 111010|101000 010100|110101 100000|111110",
            "000011|001111 010101|010101 111010|101000 010100|110101 100000|111110",
            "000011|001111 010101|010101 010110|100101 111010|101000 100000|111110",
            "000001|011111 111010|101000 000010|101111 010100|110101 100000|111110",
            "000011|001111 000001|011111 111010|101000 010100|110101 100000|111110",
            "111011|001000 000011|001111 010101|010101 111110|100000 100000|111110",
            "010011|001101 100001|011110 111010|101000 100010|101110 010100|110101",
            "010111|000101 100001|011110 111010|101000 100010|101110 010100|110101",
            "000011|001111 100001|011110 111010|101000 100010|101110 010100|110101",
            "010101|010101 100001|011110 010110|100101 111010|101000 100010|101110",
            "000011|001111 100001|011110 111010|101000 110010|101100 010100|110101",
            "000011|001111 100001|011110 111010|101000 111010|101000 010100|110101",
            "000011|001111 100001|011110 110110|100100 111010|101000 010100|110101",
            "010101|010101 100001|011110 110110|100100 111010|101000 000010|101111",
            "000011|001111 010101|010101 100001|011110 110110|100100 111010|101000",
            "000011|001111 100001|011110 111110|100000 111010|101000 010100|110101",
            "010101|010101 100001|011110 111110|100000 111010|101000 000010|101111",
            "000011|001111 010101|010101 100001|011110 111110|100000 111010|101000",
            "010011|001101 100011|001110 100001|011110 111010|101000 010100|110101",
            "010111|000101 100011|001110 100001|011110 111010|101000 010100|110101",
            "100011|001110 000011|001111 100001|011110 111010|101000 010100|110101",
            "100011|001110 010101|010101 100001|011110 010110|100101 111010|101000",
            "110011|001100 000011|001111 100001|011110 111010|101000 010100|110101",
            "111011|001000 000011|001111 100001|011110 111010|101000 010100|110101",
            "110111|000100 000011|001111 100001|011110 111010|101000 010100|110101",
            "000011|001111 100001|011110 111010|101000 010100|110101 010000|111101",
            "010001|011101 100001|011110 111010|101000 000010|101111 010100|110101",
            "000011|001111 010001|011101 100001|011110 111010|101000 010100|110101",
            "010101|010101 100001|011110 111010|101000 000010|101111 010100|110101",
            "000011|001111 010101|010101 100001|011110 111010|101000 010100|110101",
            "000011|001111 100001|011110 111010|101000 010010|101101 010100|110101",
            "000011|001111 100001|011110 010110|100101 111010|101000 010100|110101",
            "010101|010101 100001|011110 010110|100101 111010|101000 000010|101111",
            "000011|001111 010101|010101 100001|011110 010110|100101 111010|101000",
            "010011|001101 100001|011110 111010|101000 000010|101111 010100|110101",
            "010011|001101 000011|001111 100001|011110 111010|101000 010100|110101",
            "010111|000101 100001|011110 111010|101000 000010|101111 010100|110101",
            "010111|000101 000011|001111 100001|011110 111010|101000 010100|110101",
            "000011|001111 100001|011110 111010|101000 000010|101111 010100|110101",
            "100001|011110 000001|011111 111010|101000 000010|101111 010100|110101",
            "000011|001111 100001|011110 000001|011111 111010|101000 010100|110101",
            "111011|001000 000011|001111 100001|011110 111110|100000 010100|110101",
            "111011|001000 010101|010101 100001|011110 111110|100000 000010|101111",
            "111011|001000 000011|001111 010101|010101 100001|011110 111110|100000",
        ],
        &g,
        &solutions,
    )
}
